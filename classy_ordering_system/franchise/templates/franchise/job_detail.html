{% extends 'app-layout.html' %}
{% load static%}
{% block extra_stylesheets %}
<style>

.list-group-item{
	background-color:#e4e6ef;
}

.jstree-default .jstree-clicked {
	background-color:deepskyblue;
}</style>
<link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />
{% endblock %}
{% block breadcrumb %}

    <div class="page-title d-lg-flex d-none  align-items-center flex-wrap me-3 mb-5 mb-lg-0 mx-3">
        <ul class="breadcrumb breadcrumb-separatorless fw-bold fs-7 my-1">
            <li class="breadcrumb-item text-muted">
                <a href="{% url 'dashboard'%}"
                    class="text-muted text-hover-primary">Home</a>
            </li>
            <li class="breadcrumb-item">
                <span class="bullet bg-gray-200 w-5px h-2px"></span>
            </li>
            <li class="breadcrumb-item text-muted"> <a
                    href="{% url 'franchise:create-job' %}"
                    class="text-muted text-hover-primary">Order</a></li>

            <li class="breadcrumb-item">
                <span class="bullet bg-gray-200 w-5px h-2px"></span>
            </li>
            <li class="breadcrumb-item text-dark">{% block crumb %}  Order Item {% endblock %}</li>
        </ul>
        <!--end::Breadcrumb-->
    </div>
{% endblock %}

{% block option_title %} Order Item {% endblock %}
{% block navbartitle %} Order Item {% endblock %}

{% block content %}
<div class="content d-flex flex-column flex-column-fluid" id="kt_content">

    <!--Begin::Breadcrumb-->
    <div class="page-title d-block d-lg-none mb-5 mb-lg-0 mx-3">
        <h1 class="d-flex align-items-center text-dark fw-bolder my-1 fs-3">Order Item</h1>
        <ul class="breadcrumb breadcrumb-separatorless fw-bold fs-7 my-1">
            <li class="breadcrumb-item text-muted">
                <a href="{% url 'dashboard'%}" class="text-muted text-hover-primary">Home</a>
            </li>
            <li class="breadcrumb-item">
                <span class="bullet bg-gray-200 w-5px h-2px"></span>
            </li>
            <li class="breadcrumb-item text-muted">Order</li>
            <li class="breadcrumb-item">
                <span class="bullet bg-gray-200 w-5px h-2px"></span>
            </li>
            <li class="breadcrumb-item text-dark">Order item</li>
        </ul>
    </div>
    <!--end::Breadcrumb-->

    <!--begin::Post-->
    <div class="post d-flex flex-column-fluid" id="kt_post">
        <!--begin::Container-->
        <div id="kt_content_container" class="container">
            <!--begin::Row-->
            <div class="row g-5 g-xxl-8">
                <!-- Begin:: Basic info-->
                <div class="card mb-5 mb-xxl-4">
                    <div class="card-header border-0 pt-5 flex-column">
                        <div class="d-flex align-items-center mb-2">
                            <h3 class="text-gray-800 text-hover-primary fs-2 fw-bolder me-1">
                            </h3>
                            <a href="#">
                                <!--begin::Svg Icon | path: icons/duotone/Design/Verified.svg-->
                                <!-- <span class="svg-icon svg-icon-1 svg-icon-primary">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                            <path d="M10.0813 3.7242C10.8849 2.16438 13.1151 2.16438 13.9187 3.7242V3.7242C14.4016 4.66147 15.4909 5.1127 16.4951 4.79139V4.79139C18.1663 4.25668 19.7433 5.83365 19.2086 7.50485V7.50485C18.8873 8.50905 19.3385 9.59842 20.2758 10.0813V10.0813C21.8356 10.8849 21.8356 13.1151 20.2758 13.9187V13.9187C19.3385 14.4016 18.8873 15.491 19.2086 16.4951V16.4951C19.7433 18.1663 18.1663 19.7433 16.4951 19.2086V19.2086C15.491 18.8873 14.4016 19.3385 13.9187 20.2758V20.2758C13.1151 21.8356 10.8849 21.8356 10.0813 20.2758V20.2758C9.59842 19.3385 8.50905 18.8873 7.50485 19.2086V19.2086C5.83365 19.7433 4.25668 18.1663 4.79139 16.4951V16.4951C5.1127 15.491 4.66147 14.4016 3.7242 13.9187V13.9187C2.16438 13.1151 2.16438 10.8849 3.7242 10.0813V10.0813C4.66147 9.59842 5.1127 8.50905 4.79139 7.50485V7.50485C4.25668 5.83365 5.83365 4.25668 7.50485 4.79139V4.79139C8.50905 5.1127 9.59842 4.66147 10.0813 3.7242V3.7242Z" fill="#00A3FF"></path>
                                            <path class="permanent" d="M14.8563 9.1903C15.0606 8.94984 15.3771 8.9385 15.6175 9.14289C15.858 9.34728 15.8229 9.66433 15.6185 9.9048L11.863 14.6558C11.6554 14.9001 11.2876 14.9258 11.048 14.7128L8.47656 12.4271C8.24068 12.2174 8.21944 11.8563 8.42911 11.6204C8.63877 11.3845 8.99996 11.3633 9.23583 11.5729L11.3706 13.4705L14.8563 9.1903Z" fill="white"></path>
                                        </svg>
                                    </span> -->
                                <!--end::Svg Icon-->
                            </a>
                        </div>
                        <h3 class="card-title align-items-start  col-lg-8 d-md-flex d-block justify-content-between">
                            <span class="card-label fs-6 mb-1 d-block mb-3"> <strong>Client ID: </strong>
                                #{{job.client_id}}</span>
                            <span class="card-label fs-6 mb-1 d-block mb-3"> <strong>Job ID: </strong>
                                #{{job.job_id}}</span>
                            <span id="room_name" class="card-label fs-6 mb-1 d-block mb-3"> <strong>Room Name: </strong> No Rooms Selected</span>
                        </h3>

                    </div>
                    <div class="card-body pb-0">
                    </div>
                </div>
                <!-- End:: Basic info-->
                {% include 'room_options/partials/_room_nav.html' with all_rooms=job.job_room.all room=job.room %}


                <!--Begin::  -->
                <div class="col-xl-6">
                    <div class="card mb-5 mb-xxl-8">
                        <div class="card-header border-0 pt-5">
                            <h3 class="card-title align-items-start flex-row justify-content-between w-100 align-items-center">
                                <span class="card-label fs-3 mb-1"> Add Room</span>
                                <!-- <a href="#!" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#kt_modal_add_customer">
                                    <span class="svg-icon svg-icon-2">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                            xmlns:xlink="http://www.w3.org/1999/xlink" width="24px"
                                            height="24px" viewBox="0 0 24 24" version="1.1">
                                            <rect fill="#000000" x="4" y="11" width="16" height="2"
                                                rx="1" />
                                            <rect fill="#000000" opacity="0.5"
                                                transform="translate(12.000000, 12.000000) rotate(-270.000000) translate(-12.000000, -12.000000)"
                                                x="4" y="11" width="16" height="2" rx="1" />
                                        </svg>
                                    </span> Add room</a> -->
                                    <a href="{% url 'franchise:create-room' job_id=job.id%}" class="btn btn-primary">
                                        <span class="svg-icon svg-icon-2">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                xmlns:xlink="http://www.w3.org/1999/xlink" width="24px"
                                                height="24px" viewBox="0 0 24 24" version="1.1">
                                                <rect fill="#000000" x="4" y="11" width="16" height="2"
                                                    rx="1" />
                                                <rect fill="#000000" opacity="0.5"
                                                    transform="translate(12.000000, 12.000000) rotate(-270.000000) translate(-12.000000, -12.000000)"
                                                    x="4" y="11" width="16" height="2" rx="1" />
                                            </svg>
                                        </span> Add Room</a>
                            </h3>
                        </div>
                        <div class="card-body">

                            <!-- Begin:: Button list -->
                            <div class=" mt-10 room-types">
                                <a id='room_partition' href="" class="btn btn-secondary mb-2 mx-1 disabled ">Partition</a>
                                <a id='kd_shelf' href="{% if room_first %}{% url 'room_options:room-kd-shelf' room_id=room_first.id %}{% endif %}" class="btn btn-secondary mb-2 mx-1 disabled">KD</a>
                                <a id='adj_shelf' href="{% if room_first %}{% url 'room_options:room-adj-shelf' room_id=room_first.id  %}{% endif %}" class="btn btn-secondary mb-2 mx-1 disabled">Adj.
                                    Shelf</a>
                                <a id='pair_door' data-url href="" class=" disabled btn btn-secondary mb-2 mx-1 disabled ">Door 1/2
                                    pair</a>
                                <a id='single_door' href="{% if room_first %} {% url 'room_options:single-door' room_id=room_first.id %} {% endif %}" class="btn btn-secondary mb-2 mx-1 disabled  ">Door
                                    Single</a>
                                <a id='drawer_faces' href="#" class="btn btn-secondary mb-2 mx-1 disabled">Drawer
                                    Face</a>
                                <a id="drawer_boxes" href="#" class="btn btn-secondary mb-2 mx-1 disabled "
                                        >
                                        Drawer Box
                                    </a>
                                <a id="l_shelf" href="#" class="btn btn-secondary mb-2 mx-1 disabled">L-Shelf</a>
                                <a id="corner_shelf" href="" class="btn btn-secondary mb-2 mx-1 disabled">Corner
                                    Shelf</a>
                                <a href="#" id="cleats-stricker" class="btn btn-secondary mb-2 mx-1 disabled">Cleat</a>
                                <a id="top_shelf" href="#" class="btn btn-secondary mb-2 mx-1 disabled">Top Shelf</a>
                                <a href="#" id="toe-kicks" class="btn btn-secondary mb-2 mx-1 disabled">Toe Kick</a>
                                <a href="#" class="btn btn-secondary mb-2 mx-1 disabled">Wall Bed</a>
                                <!-- <a href="#" class="btn btn-secondary mb-2 mx-1 disabled">Garages</a> -->
                                <a id="wood_doors" href="#" class="btn btn-secondary mb-2 mx-1 disabled">Wood Door</a>
                                <a id='lti_doors' href="#" class="btn btn-secondary mb-2 mx-1 disabled">LTI Doors</a>
                                <a href="#" id="custom-form" class="btn btn-secondary mb-2 mx-1 disabled">Custom</a>
                                <!-- <a href="#" class="btn btn-secondary mb-2 mx-1 disabled">Pocket
                                    Doors</a> -->
                                <a href="#" class="btn btn-secondary mb-2 mx-1 disabled">Molding
                                    Etc.</a>
                                <!-- <a href="#" class="btn btn-secondary mb-2 mx-1 disabled">Daytona Garage
                                    Specials</a> -->
                            </div>
                            <!-- End:: Button list -->
                        </div>
                    </div>
                </div>

                <!--begin::Col-->
                <div class="col-xl-6">
                    <!--begin::Charts Widget 1-->
                    <div class="card mb-5 mb-xxl-8">
                        <!--begin::Header-->
                        <div class="card-header border-0 pt-5">
                            <!--begin::Title-->
                            <h3 class="card-title align-items-start flex-column">
                                <span class="card-label fw-bolder fs-3 mb-1">Job Id: {{job.job_id}}</span>
                            </h3>
                            <!-- <button type="button" class="btn btn-primary" id="send_order" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-up-circle-fill" viewBox="0 0 16 16">
                                     <path d="M16 8A8 8 0 1 0 0 8a8 8 0 0 0 16 0zm-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5z"></path>
                                </svg>&nbsp;&nbsp; Send Order
                              </button> -->

                            <!--end::Title-->
                        </div>
                        <!--end::Header-->
                        <!--begin::Body-->

                        <div class="card-body tree-scroll" style="width:95%">
                            {% if rooms|length == 0 %}
                            <p>No Room is available</p>
                            {% else %}
                            <div  class='' id="tree"></div>
                            {% endif %}
                        </div>
                        <!--end::Body-->
                    </div>
                    <!--end::Charts Widget 1-->


                </div>
                <!--end::Col-->
            </div>
            <!--end::Row-->
        </div>
        <!--end::Container-->
    </div>
    <!--end::Post-->
</div>
<div class="d-none" id='all_room_names'>
    {% for room  in  job.job_room.all %}
    <input type="hidden" value="{{room.room_name}}">
    {% endfor %}
</div>
<div class="d-block" id='disabled_nodes'>
    {% for each_node  in  disabled_nodes %}
    <input type="hidden" value="{{each_node}}">
    {% endfor %}
</div>




{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
<script>
    showRoomOptions= (roomID,roomText)=>{
        $('#room_name').html("<strong>Room Name:    </strong>"+roomText)
        $('#room_partition').removeClass("disabled").attr('href',"/classy/room/room_partition/"+roomID)
        $('#pair_door').removeClass("disabled").attr('href',"/classy/room/pair_doors/"+roomID)
        $('#single_door').removeClass("disabled").attr('href',"/classy/room/single_door/"+roomID)
        $('#drawer_boxes').removeClass("disabled").attr('href',"/classy/room/drawer_box/"+roomID)
        $('#pair_door').removeClass("disabled").attr('href',"/classy/room/pair_doors/"+roomID)
        $('#pair_door').removeClass("disabled").attr('href',"/classy/room/pair_doors/"+roomID)
        $('#pair_door').removeClass("disabled").attr('href',"/classy/room/pair_doors/"+roomID)
        $('#kd_shelf').removeClass("disabled").attr('href',"/classy/room/room_kd_shelf/"+roomID)
        $('#cleats-stricker').removeClass("disabled").attr('href',"/classy/room/cleat/"+roomID)
        $('#l_shelf').removeClass("disabled").attr('href',"/classy/room/l-shelf/"+roomID)
        $('#corner_shelf').removeClass("disabled").attr('href',"/classy/room/corner-shelf/"+roomID)
        $('#top_shelf').removeClass("disabled").attr('href',"/classy/room/top-shelf/"+roomID)
        $('#drawer_faces').removeClass("disabled").attr('href',"/classy/room/drawer-faces/"+roomID)
        $('#adj_shelf').removeClass("disabled").attr('href',"/classy/room/room_adj_shelf/"+roomID)
        $('#custom-form').removeClass("disabled").attr('href',"/classy/room/custom/"+roomID)
        $('#toe-kicks').removeClass("disabled").attr('href',"/classy/room/toe-kicks/"+roomID)
        $('#lti_doors').removeClass("disabled").attr('href',"/classy/room/lti-doors/"+roomID)
        

        $('#wood_doors').removeClass("disabled").attr('href',"/classy/room/wood-doors/"+roomID)     

    }

        $('input[type=radio][name=roomList]').change(function() {

        showRoomOptions(this.value,$(this).data("room_text")  );

        });
    



    // ------Vertical-tree-view
    $(document).ready(function () {
        var tree = $('#tree').tree({
            primaryKey: 'id',
            uiLibrary: 'bootstrap4',
            dataSource: '{% url "franchise:job-detail-tree-data" job_id=job.id %}',
            checkboxes: true,
            border: true,
            selectionType: 'single',
            imageHtmlField:'delete_url',
            select: function (e, node, id) {
            if(id !== 'undefined' && typeof id != Number){
                window.location.href=id;
            }
            
         },
        });
        setTimeout(function(){ 
    
            node = tree.getNodeByText('Job Id- {{job.job_id}}'); 
            tree.expand(node);
            
            $('#all_room_names input').each(function () {
                node = tree.getNodeByText(this.value) 
                tree.expand(node);
             });      
             
            // tree.expandAll()
            // for disable 
            $('#disabled_nodes input').each(function () {
               // console.log(tree.getNodeById(this.value))
                nodeSelected = tree.getNodeById(this.value)  !== undefined ?tree.getNodeById(this.value) :tree.getNodeByText(this.value)
                console.log('selected ===>',this.value)
                tree.disable(nodeSelected,false);
                tree.expand(nodeSelected);  
                tree.check(nodeSelected);
                
                  
             });
                   
         }, 200);
         getCheckedNodesCustom=()=>{
               
               var a = [],
                   b = tree.find('li [data-role="checkbox"] input[type="checkbox"]');
              
                   $.each(b, function () {
                       var b = $(this);
                       if( b.checkbox("state")==="checked" ){
                       a.push(b.closest("li").find('button').data("delete_id"));
                       a.push(b.closest("li").find('button').data("model"));
                       a.push(b.closest("li").find('button').data("description"));
                       }
                   })
                   
              return a
           }  
           setTimeout(function(){ 
    
            tree.on('checkboxChange', function (e, $node, record, state) {
                    //alert('The new state of record ' + record.text + ' is ' + state);   
                    $('#send_order').removeAttr("disabled")
                });
            $('#send_order').on("click",function(){
                var result = getCheckedNodesCustom();
                sendOrder("{% url 'franchise:job-detail-send-order' job.id %}",result)
            })
            
            },300);
        function sendOrder(url,result){
            $.ajax({                       
            url: url,                  
            data: {"send_order_list":JSON.stringify(result)
                },
            success: function (data) {
               data=JSON.parse(data)
                if(data['status']==200){
               Swal.fire({
                     title:    'Order Sent',
                     text: 'Your order has been sent Successfully ',
                     icon:  'success',
                     
                     customClass: {
                     confirmButton: 'btn btn-primary',            
                      },
                     });
                  } 
            window.location.reload();
            }   
        });

        }  
        // unchecked the selected room
        if ($("input[type=radio]").is(':checked')){
            $("input[type=radio]").prop('checked', false);
        }
        /* $('#btnSave').on('click', function () {
            var checkedIds = tree.getCheckedNodes();
            $.ajax({ url: '/Locations/SaveCheckedNodes', data: { checkedIds: checkedIds }, method: 'POST' })
                .fail(function () {
                    alert('Failed to save.');
                });
        });*/

        function enableRoom (roomId){
    
    $('#room_'+roomId).trigger('click');
  }
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');   
            if(roomId){
            setTimeout(enableRoom(roomId),100)
            
        }

    });
    
 deleteRoomItem=(url,pk,model,description)=>{
   $.ajax({                       
            url: url,                  
            data: {"pk":pk,'model':model,'description':description
                },
            success: function (data) {
               data=JSON.parse(data)
                if(data['status']==204){
               Swal.fire({
                     title:    'Deleted!',
                     text: 'Your data has been deleted.',
                     icon:  'success',
                     customClass: {
                     confirmButton: 'btn btn-primary',            
                      },
                     });
                  } 
                window.location.replace("{% url 'franchise:job-detail' job.id %}")
            }   
        });
}

    $(document).on("click", ".del-data", function (e) {
      pk= $(this).data('delete_id')
      model=$(this).data('model')
      description=$(this).data('description')
    
    Swal.fire({
        title: 'Are you sure? <br> All of the following related items will be deleted: <b>Room,</b> <br><b>Room Options Master</b>',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,       
        customClass: {
            confirmButton: 'btn btn-primary',
            cancelButton: 'btn btn-secondary'
          },
        confirmButtonText: 'Yes, delete it!'
      }).then((result) => {
        if (result.isConfirmed) {
         deleteRoomItem("{% url 'franchise:delete-room' %}",pk,model,description)
        }
      })
    e.preventDefault();
});




</script>

{% endblock %}